{% extends "base.html" %}

{% block title %}Admin - Order #{{ order.id }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>Order #{{ order.id }} (Admin View)</h1>
        <a href="{{ url_for('admin.orders_dashboard') }}" class="btn btn-secondary btn-sm">&larr; Back to Dashboard</a>
    </div>
</div>

<div class="row">
    <!-- Order Information -->
    <div class="col-md-8">
        <!-- Customer Info -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ‘¤ Customer</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Name:</strong> {{ user.first_name or user.username }} {{ user.last_name or '' }}</p>
                <p class="mb-1"><strong>Email:</strong> {{ user.email }}</p>
                <p class="mb-1"><strong>Username:</strong> {{ user.username }}</p>
                <p class="mb-0"><strong>Phone:</strong> {{ user.phone or 'Not provided' }}</p>
            </div>
        </div>

        <!-- Order Details -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ½ï¸ Restaurant</h5>
            </div>
            <div class="card-body">
                <h5>{{ order.restaurant.name }}</h5>
                <p class="text-muted">{{ order.restaurant.description }}</p>
                <p class="mb-0"><strong>Address:</strong> {{ order.restaurant.address }}, {{ order.restaurant.city }}</p>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ“¦ Items</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Item</th>
                            <th class="text-end">Price</th>
                            <th class="text-center">Qty</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items %}
                            <tr>
                                <td>{{ item.menu_item_name }}</td>
                                <td class="text-end">${{ "%.2f"|format(item.unit_price) }}</td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end"><strong>${{ "%.2f"|format(item.unit_price * item.quantity) }}</strong></td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td class="text-end"><strong>${{ "%.2f"|format(order.total_price) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Delivery & Notes -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">ğŸ“ Delivery</h5>
            </div>
            <div class="card-body">
                <p><strong>Address:</strong><br>{{ order.delivery_address }}</p>
                {% if order.special_instructions %}
                    <p><strong>Special Instructions:</strong><br>{{ order.special_instructions }}</p>
                {% endif %}
                {% if order.notes %}
                    <p><strong>Notes:</strong><br>{{ order.notes }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Status Management -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“Š Status Management</h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <strong>Current Status:</strong><br>
                    <span class="badge bg-{% if order.status.value == 'pending' %}warning{% elif order.status.value == 'confirmed' %}info{% elif order.status.value == 'preparing' %}primary{% elif order.status.value == 'ready' %}success{% elif order.status.value == 'delivered' %}success{% else %}danger{% endif %} p-2">
                        {{ order.status.value.upper() }}
                    </span>
                </p>

                <hr>

                <h6>Update Status</h6>
                <form method="POST" action="{{ url_for('admin.update_order_status', order_id=order.id) }}">
                    <input type="hidden" name="status" id="statusInput">
                    
                    {% if order.status.value == 'pending' %}
                        <button type="button" class="btn btn-sm btn-info w-100 mb-2" onclick="updateStatus('confirmed')">
                            âœ“ Confirm Order
                        </button>
                        <button type="button" class="btn btn-sm btn-danger w-100" onclick="updateStatus('cancelled')">
                            âœ— Cancel Order
                        </button>
                    {% elif order.status.value == 'confirmed' %}
                        <button type="button" class="btn btn-sm btn-primary w-100 mb-2" onclick="updateStatus('preparing')">
                            ğŸ‘¨â€ğŸ³ Start Preparing
                        </button>
                        <button type="button" class="btn btn-sm btn-danger w-100" onclick="updateStatus('cancelled')">
                            âœ— Cancel Order
                        </button>
                    {% elif order.status.value == 'preparing' %}
                        <button type="button" class="btn btn-sm btn-success w-100" onclick="updateStatus('ready')">
                            âœ“ Mark Ready
                        </button>
                    {% elif order.status.value == 'ready' %}
                        <button type="button" class="btn btn-sm btn-success w-100" onclick="updateStatus('delivered')">
                            ğŸšš Mark Delivered
                        </button>
                    {% else %}
                        <p class="text-muted mb-0">No actions available for this status</p>
                    {% endif %}
                </form>

                <hr>

                <h6>Order Info</h6>
                <p class="small mb-1">
                    <strong>Order Date:</strong><br>
                    {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                </p>
                <p class="small mb-0">
                    <strong>Customer ID:</strong> {{ user.id }}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function updateStatus(status) {
    if (confirm('Are you sure you want to update the order status to ' + status.toUpperCase() + '?')) {
        document.getElementById('statusInput').value = status;
        document.querySelector('form').submit();
    }
}
</script>
{% endblock %}
