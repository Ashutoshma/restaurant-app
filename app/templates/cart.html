{% extends "base.html" %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>üõí Shopping Cart</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        {% if cart_data %}
            {% for cart_item in cart_data %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{{ cart_item.restaurant.name }}</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th class="text-end">Price</th>
                                    <th class="text-center">Quantity</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_item.items %}
                                    <tr>
                                        <td>{{ item.name }}</td>
                                        <td class="text-end">${{ "%.2f"|format(item.price) }}</td>
                                        <td class="text-center">
                                            <div class="input-group input-group-sm" style="width: 100px; margin: 0 auto;">
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="updateQuantity({{ cart_item.restaurant.id }}, '{{ item.item_id }}', Math.max(parseInt(document.getElementById('qty-{{ item.item_id }}').value) - 1, 0))">‚àí</button>
                                                <input type="number" id="qty-{{ item.item_id }}" class="form-control text-center" 
                                                       value="{{ item.quantity }}" min="0" style="width: 40px;">
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="updateQuantity({{ cart_item.restaurant.id }}, '{{ item.item_id }}', parseInt(document.getElementById('qty-{{ item.item_id }}').value) + 1)">+</button>
                                            </div>
                                        </td>
                                        <td class="text-end">${{ "%.2f"|format(item.price * item.quantity) }}</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-danger" type="button"
                                                    onclick="removeItem({{ cart_item.restaurant.id }}, '{{ item.item_id }}')">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end"><strong>${{ "%.2f"|format(cart_item.total) }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">Your Cart is Empty</h4>
                <p>Start adding items to your cart by browsing restaurants and menus.</p>
                <a href="{{ url_for('restaurants.list_restaurants') }}" class="btn btn-primary">Browse Restaurants</a>
            </div>
        {% endif %}
    </div>
    
    <!-- Cart Summary Sidebar -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                {% if cart_data %}
                    <div class="mb-3">
                        <p>
                            <strong>Items:</strong> 
                            <span class="float-end">{{ item_count }}</span>
                        </p>
                        <p>
                            <strong>Subtotal:</strong> 
                            <span class="float-end">${{ "%.2f"|format(grand_total) }}</span>
                        </p>
                        <p>
                            <strong>Delivery Fee:</strong> 
                            <span class="float-end">$0.00</span>
                        </p>
                        <hr>
                        <h5>
                            <strong>Total:</strong> 
                            <span class="float-end text-primary">${{ "%.2f"|format(grand_total) }}</span>
                        </h5>
                    </div>
                    
                    <a href="{{ url_for('orders.create') }}" class="btn btn-success btn-lg w-100 mb-2">
                        Proceed to Checkout
                    </a>
                    <a href="{{ url_for('restaurants.list_restaurants') }}" class="btn btn-outline-secondary btn-lg w-100 mb-2">
                        Continue Shopping
                    </a>
                    <button onclick="clearCart()" class="btn btn-outline-danger btn-sm w-100">
                        Clear Cart
                    </button>
                    
                    <div class="alert alert-info mt-3" role="alert">
                        <small>
                            üí° You can only order from one restaurant at a time. Items from different restaurants will replace your current cart.
                        </small>
                    </div>
                {% else %}
                    <p class="text-muted">No items in cart</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function removeItem(restaurantId, itemId) {
    if (confirm('Remove this item from cart?')) {
        fetch('/cart/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                restaurant_id: restaurantId,
                item_id: itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error removing item from cart');
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function updateQuantity(restaurantId, itemId, quantity) {
    if (quantity < 0) return;
    
    fetch('/cart/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            restaurant_id: restaurantId,
            item_id: itemId,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating cart');
        }
    })
    .catch(error => console.error('Error:', error));
}

function clearCart() {
    if (confirm('Are you sure you want to clear your entire cart?')) {
        fetch('/cart/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error clearing cart');
            }
        })
        .catch(error => console.error('Error:', error));
    }
}
</script>
{% endblock %}
